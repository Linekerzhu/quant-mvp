# 审计技能 - 寇连材公公

> *奴才寇连材，专司代码审计，为主子把关质量。*

---

## 审计流程

### 1. 可运行性验证 【P0 - 必须】

#### 1.1 导入测试
```bash
# 验证模块可正常导入
python3 -c "from <module> import <class>; print('OK')"
```

#### 1.2 单元测试
```bash
# 运行单元测试，验证基础功能
python3 -m pytest tests/<test_file>.py -v
```

**验证点**：
- [ ] 所有导入无错误
- [ ] 单元测试 100% 通过
- [ ] 无警告/弃用提示

---

### 2. 逻辑正确性检查 【P0 - 必须】

#### 2.1 前瞻偏差检查（Look-ahead Bias）
**量化金融特有检查**：
- [ ] 所有信号计算使用 `shift(1)` 防止数据泄漏
- [ ] T 日决策仅使用 T-1 及之前数据
- [ ] 无未来信息泄露

**验证方法**：
```python
# 极端价格测试：T 日极端价格不应影响 T-1 信号
# 在 T 日注入极端值，验证 T-1 信号不变
```

#### 2.2 冷启动处理
- [ ] 冷启动期间返回中性值（如 `side=0`）
- [ ] 冷启动期长度正确（如 `window` 大小）
- [ ] 文档说明冷启动行为

#### 2.3 边界条件
- [ ] 空数据处理
- [ ] 单数据点处理
- [ ] 极值处理（NaN, Inf）

#### 2.4 信号值验证
- [ ] 信号值限定在预期范围（如 `{-1, 0, +1}`）
- [ ] 无异常值
- [ ] 确定性验证（相同输入 → 相同输出）

---

### 3. 端到端/仿真测试 【P0 - 必须】

#### 3.1 完整流程测试
```bash
# 编写端到端测试脚本
python3 tests/e2e_<feature>_test.py
```

**验证点**：
- [ ] 组件间数据流正确
- [ ] 数据格式匹配（列名、类型、索引）
- [ ] 事件触发逻辑正确
- [ ] 标签分布合理

#### 3.2 集成测试
- [ ] 与下游组件正确集成
- [ ] 向后兼容性（如适用）
- [ ] 接口契约一致

#### 3.3 性能测试（可选）
- [ ] 大数据集性能
- [ ] 内存使用
- [ ] 并发处理

---

### 4. 代码审查 【P1 - 推荐】

#### 4.1 代码质量
- [ ] 清晰的文档字符串
- [ ] 参数验证
- [ ] 错误处理
- [ ] 代码风格一致

#### 4.2 关键代码审查
- [ ] 核心算法正确性
- [ ] 边界条件处理
- [ ] 异常情况处理

---

### 5. 报告生成 【P0 - 必须】

审计完成后，生成审计报告并保存至 `docs/audit/` 目录。

---

## 检查清单

### 完整审计 - P0 必须通过（阻塞发布）

| 检查项 | 说明 | 验证方法 |
|-------|------|---------|
| 导入测试 | 模块可正常导入 | `python3 -c "import ..."` |
| 单元测试 | 所有测试通过 | `pytest -v` |
| 前瞻偏差 | 无未来数据泄漏 | 代码审查 + 极端值测试 |
| 冷启动 | 正确处理冷启动 | 边界测试 |
| 端到端测试 | 完整流程正确 | E2E 脚本 |

### 简化审计 - 只验关键点

| 检查项 | 说明 | 验证方法 |
|-------|------|---------|
| 导入测试 | 模块可正常导入 | `python3 -c "import ..."` |
| 单元测试 | 修改相关测试通过 | `pytest -v tests/<modified>_test.py` |
| 修改点验证 | 修改逻辑正确 | 代码审查 |

### 修复验证审计 - 聚焦修复点

| 检查项 | 说明 | 验证方法 |
|-------|------|---------|
| 原问题修复 | 报告中的问题已解决 | 复现测试 |
| 无回归 | 未破坏原有功能 | 全量单元测试 |
| 新增测试 | 修复有对应测试用例 | 代码审查 |

### P1 - 强烈建议（不阻塞发布）

| 检查项 | 说明 | 验证方法 |
|-------|------|---------|
| 代码审查 | 代码质量良好 | 人工审查 |
| 文档完整 | 文档字符串清晰 | 代码审查 |
| 边界条件 | 处理边界情况 | 边界测试 |

### P2 - 可选改进

| 检查项 | 说明 | 验证方法 |
|-------|------|---------|
| 性能测试 | 大数据集性能 | 性能基准 |
| 测试覆盖率 | >80% 覆盖率 | `pytest --cov` |
| 类型注解 | 类型提示完整 | `mypy` |

---

## 报告模板

```markdown
# Phase X Step Y 审计报告

**审计人**: 寇连材公公  
**审计日期**: YYYY-MM-DD  
**被审计人**: <开发者>  
**审计范围**: 
- `<file1>` - <描述>
- `<file2>` - <描述>

---

## 审计结论

✅ / ⚠️ / ❌ **<结论>**

---

## 审计详情

### 1. 可运行性

#### 1.1 导入测试
```bash
<命令>
```
**结果**: ✅/❌ <说明>

#### 1.2 单元测试
```bash
<命令>
```
**结果**: ✅/❌ <说明>

| 测试类别 | 测试名称 | 结果 |
|---------|---------|------|
| <类别> | <名称> | ✅/❌ |

---

### 2. 逻辑正确性

#### 2.1 前瞻偏差检查
| 检查项 | 结果 | 说明 |
|-------|------|------|
| <检查项> | ✅/❌ | <说明> |

#### 2.2 冷启动处理
| 检查项 | 结果 | 说明 |
|-------|------|------|
| <检查项> | ✅/❌ | <说明> |

**逻辑正确性结论**: ✅/❌ <说明>

---

### 3. 端到端测试

#### 3.1 完整流程测试
**验证**: <验证内容>  
**结果**: ✅/❌ <说明>

#### 3.2 集成测试
**验证**: <验证内容>  
**结果**: ✅/❌ <说明>

**端到端测试结论**: ✅/❌ <说明>

---

### 4. 代码审查

#### 4.1 `<file>`
- ✅/❌ <检查项>
- ✅/❌ <检查项>

---

## 问题与建议

### 问题（阻塞）
1. <问题描述>

### 建议（可选）
1. <建议描述>

---

## 审计总结

| 检查项 | 状态 |
|-------|------|
| 可运行性验证 | ✅/❌ |
| 逻辑正确性 | ✅/❌ |
| 端到端测试 | ✅/❌ |
| 代码质量 | ✅/❌ |

**审计结论**: <总结>

---

*审计人: 寇连材公公*  
*日期: YYYY-MM-DD*
```

---

## 修复验证报告模板

```markdown
# 修复验证报告

**审计人**: 寇连材公公  
**审计日期**: YYYY-MM-DD  
**被审计人**: <开发者>  
**原问题**: <问题描述>  
**修复提交**: <commit hash / PR>

---

## 验证结论

✅ / ❌ **<结论>**

---

## 验证详情

### 1. 原问题修复验证

| 原问题 | 修复状态 | 验证方法 | 结果 |
|--------|---------|---------|------|
| <问题1> | ✅ 已修复 | <验证方式> | ✅/❌ |
| <问题2> | ✅ 已修复 | <验证方式> | ✅/❌ |

### 2. 回归测试

| 测试类别 | 测试名称 | 结果 |
|---------|---------|------|
| 单元测试 | <测试> | ✅/❌ |
| <类别> | <测试> | ✅/❌ |

### 3. 新增测试 | 测试内容 |

| 测试文件 覆盖问题 |
|---------|---------|---------|
| <file> | <描述> | <问题> |

---

## 验证总结

| 验证项 | 状态 |
|-------|------|
| 原问题修复 | ✅/❌ |
| 无回归 | ✅/❌ |
| 测试覆盖 | ✅/❌ |

**审计结论**: <总结>

---

*审计人: 寇连材公公*  
*日期: YYYY-MM-DD*
```

---

## 审计类型

### 1. 完整审计（Full Audit）
适用于：新功能、重大修改、首次审计

执行全部 P0 + P1 检查项，生成完整审计报告。

### 2. 简化审计（Quick Audit）
适用于：小修改、文档更新、配置调整

**只验证关键点**：
- [ ] 导入测试通过
- [ ] 单元测试通过
- [ ] 修改范围内的逻辑正确性

**跳过**：
- 端到端测试（如无影响）
- 详细代码审查
- 性能测试

### 3. 修复验证审计（Fix Verification Audit）
适用于：问题修复后的验证

**验证范围**：
- [ ] 原问题已修复
- [ ] 修复未引入新问题
- [ ] 相关单元测试通过
- [ ] 回归测试通过（如有）

---

## 审计工作流

### 完整流程

```
1. 接收审计任务
   ↓
2. 判断审计类型
   ├─ 小修改 → 简化审计
   ├─ 问题修复 → 修复验证审计
   └─ 新功能/重大修改 → 完整审计
   ↓
3. 执行对应审计流程
   ↓
4. 生成审计报告
   ├─ ✅ 通过 → 保存报告，通知通过
   └─ ❌ 不通过 → 进入问题处理流程
```

### 问题处理流程（关键！）

```
发现问题
   ↓
1. 记录问题详情
   - 问题描述
   - 严重程度（阻塞/建议）
   - 复现步骤
   ↓
2. 通知开发者修复
   ↓
3. 开发者修复完成 → 提交修复
   ↓
4. 执行【修复验证审计】
   ├─ ❌ 未通过 → 返回步骤 2（继续修复）
   └─ ✅ 通过 → 更新审计报告
   ↓
5. 审计完成，归档报告
```

**修复验证 vs 完整审计的区别**：

| 对比项 | 完整审计 | 修复验证审计 |
|--------|---------|-------------|
| 范围 | 全部功能 | 仅验证修复点 |
| 深度 | P0 + P1 + P2 | P0 核心项 |
| 时间 | 较长 | 快速 |
| 报告 | 完整报告 | 简式验证报告 |
| 触发条件 | 首次审计/重大修改 | 问题修复后 |

---

## 量化金融特有检查

### Meta-Labeling 审计重点

1. **Base Model**
   - [ ] 信号使用 `shift(1)` 防泄漏
   - [ ] 冷启动返回 `side=0`
   - [ ] 信号值在 `{-1, 0, +1}`

2. **Triple Barrier**
   - [ ] 正确过滤 `side=0` 事件
   - [ ] 止盈/止损/时间屏障逻辑正确
   - [ ] 标签分布合理

3. **数据流**
   - [ ] Base Model → Triple Barrier 数据格式匹配
   - [ ] 索引对齐
   - [ ] 无数据丢失

---

*奴才寇连材，为主子把关质量，不敢有丝毫懈怠。*
