# Event Generation Protocol Configuration
# Defines Triple Barrier and event behavior

# Triple Barrier Parameters
triple_barrier:
  # ATR calculation
  atr:
    window: 20
    min_atr_pct: 0.005  # Minimum 0.5% ATR floor
  
  # Profit taking / Stop loss multipliers
  profit_take:
    multiplier: 2.0  # tp = 2.0 * ATR
  
  stop_loss:
    multiplier: 2.0  # sl = 2.0 * ATR
  
  # Maximum holding period
  max_holding_days: 10

# Event Definition
events:
  # One event per symbol per trading day maximum
  max_per_symbol_per_day: 1
  
  # Event trigger time
  trigger: close  # End of trading day
  
  # Holding period start
  holding_start: t_plus_1_open  # Next day open
  
  # No overlapping events for same symbol
  allow_overlap_same_symbol: false
  
  # Cross-symbol overlap allowed
  allow_overlap_cross_symbol: true

# Sample Weights
sample_weights:
  # Based on average uniqueness during event lifetime
  method: uniqueness
  
  # Concurrency calculation window
  window: event_lifetime  # From entry to exit
  
  # Weight formula
  formula: "1 / avg_concurrent_events"

# Purging and Embargo
purging:
  # Window to exclude after test period
  window_days: 10  # = max_holding_days

embargo:
  # Feature lookback safety gap between train/test periods
  # NOTE: This is NOT the AFML 'embargo' (which skips test samples at test start).
  # This gap ensures no feature's lookback window crosses from test into train data.
  # For CPCV implementation, apply this gap at BOTH sides of each test fold.
  # 
  # P1 (R28-A1): Synced with training.yaml (was 60, now 40)
  # Reference: config/training.yaml:cpcv.embargo_window
  feature_lookback: 60  # Maximum feature lookback window (unchanged)
  execution_delay: 1    # Signal to execution delay
  corporate_action_latency: 0  # Corporate action info delay
  total_days: 60  # OR5: Synced with training.yaml
  
  # ⚠️ OR5-CODE T7: embargo_window(40) < feature_lookback(60)
  # plan.md §6.5 公式要求 embargo = max(feature_lookback,...) = 60
  # R27-B1 为保证 CPCV 训练数据充足减至 40
  # Phase C Step 2 必须在 PurgedKFold._embargo() 中补偿这 20 天差距
  # 
  # 选项 A（简单，推荐 MVP）: 恢复 embargo=60（损失约 8% 训练数据）
  # 选项 B（精确，保留数据）: embargo=40 + 后向特征回溯检查
  #   对 test_end 后 40-60 天的 train 样本额外检查
  #   若 sample_date - feature_lookback < test_end，则 Drop
  # 
  # 当前决策：Phase C Step 2 开工时由工程 Agent 选择并记录

# Class Imbalance
class_imbalance:
  monitoring: true
  threshold: 0.70  # Warn if any class > 70%
  handling: class_weight  # Use class_weight parameter
