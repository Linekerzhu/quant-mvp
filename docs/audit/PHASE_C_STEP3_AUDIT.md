# Phase C Step 3 深度审计报告

**审计人**: 寇连材公公  
**被审计人**: 李得勤公公  
**审计日期**: 2026-02-27  
**审计范围**: `src/features/fracdiff.py`, `tests/test_fracdiff.py`

---

## 执行摘要

| 项目 | 状态 | 说明 |
|------|------|------|
| 可运行性 | ✅ 通过 | Import正常，20个测试全部通过 |
| 代码结构 | ✅ 良好 | 模块化设计，接口清晰 |
| **逻辑正确性** | ⚠️ **严重问题** | 权重计算公式符号错误 |
| 因果性 | ✅ 通过 | 无前视偏误 |

---

## 1. 可运行性验证

### 1.1 Import测试
```
✅ 通过 - 所有模块导入正常
```

### 1.2 pytest测试
```
tests/test_fracdiff.py::TestFracdiffWeights::test_weights_d_0 PASSED
[...全部20个测试通过...]

============================== 20 passed in 0.80s ==============================
```

**结论**: 代码可运行，测试用例覆盖全面（权重计算、固定窗口、扩展窗口、在线计算、平稳性检测、sklearn接口、特征生成）。

---

## 2. 逻辑正确性审计

### 2.1 权重计算公式 ⚠️ 严重问题

#### 问题描述

代码实现的递推公式与AFML Ch5标准公式不符：

| | 公式 |
|---|---|
| **代码实现** | `w[k] = w[k-1] * (d - k + 1) / k` |
| **AFML Ch5标准** | `w[k] = w[k-1] * (k - 1 - d) / k` |

**差异**: 两个公式相差一个负号！

#### 影响分析

**d=1 边界情况：**
```python
# 代码结果
weights_d1 = [1, 1, 0, 0, ...]
# 计算结果: fracdiff[t] = price[t] + price[t-1]

# 正确结果（一阶差分）
weights_d1_correct = [1, -1, 0, 0, ...]
# 应计算: fracdiff[t] = price[t] - price[t-1]
```

**d=0.5 情况：**
```python
# 代码结果（符号错误）
[1.0, +0.5, -0.125, +0.0625, -0.039, ...]

# 正确结果
[1.0, -0.5, -0.125, -0.0625, -0.039, ...]
#       ↑     ✓        ↑       ✓
#     符号错          符号错
```

#### 影响程度
- **高**: 所有分数阶差分结果的权重符号部分错误
- **d=1 时**: 计算的是价格加和而非一阶差分
- **0<d<1 时**: 权重从 w[1] 开始符号交替错误

#### 修复建议

```python
# 当前实现（错误）
weights[k] = weights[k-1] * (d - k + 1) / k

# 正确实现
weights[k] = weights[k-1] * (k - 1 - d) / k
```

---

### 2.2 d=0, d=1 边界处理

| 边界值 | 预期行为 | 实际行为 | 状态 |
|--------|----------|----------|------|
| d=0 | 无差分，原序列 | 权重[1,0,0,...] 正确 | ✅ 通过 |
| d=1 | 一阶差分 | 权重[1,1,0,...] **错误** | ⚠️ 公式错误导致 |

- 值域验证: ✅ `0 <= d <= 1` 检查正确实现

---

### 2.3 因果性验证 ✅

**测试方法**: 在序列末尾添加扰动，验证历史值是否受影响

```
原始序列长度: 300
窗口大小: 100
扰动位置: 最后一个值
验证区域: 前200个值
最大差异: 0.000000000000000
```

**结论**: 实现正确，`rolling(window=window)` 确保只使用当前及之前数据，无前视偏误。

---

## 3. 代码质量审计

### 3.1 优点

1. **模块化设计**: 权重计算、固定窗口、扩展窗口、在线计算分离清晰
2. **sklearn兼容**: `FracDiffTransformer` 可直接用于流水线
3. **文档完整**: 每个函数有详细docstring
4. **测试覆盖**: 20个测试用例，覆盖权重、边界、因果性、集成测试
5. **类型注解**: 使用Python类型提示

### 3.2 改进建议

1. **修复公式符号错误**（最高优先级）
2. 在文档中明确说明 d=1 的行为
3. 添加更多理论参考值验证测试

---

## 4. 审计结论

### 总体评分: ⚠️ **有条件通过**

| 维度 | 评分 | 说明 |
|------|------|------|
| 可运行性 | ✅ A | 代码运行正常，测试通过 |
| 逻辑正确性 | ❌ C | **公式符号错误，需修复** |
| 代码质量 | ✅ A | 结构良好，文档完整 |
| 测试覆盖 | ✅ A | 20个测试用例 |

### 必要行动

1. **立即修复**: `fracdiff_weights` 函数中的公式符号错误
   ```python
   # 修改第40行
   weights[k] = weights[k-1] * (k - 1 - d) / k  # 原为 (d - k + 1)
   ```

2. **回归测试**: 修复后重新运行所有测试

3. **文档更新**: 在函数docstring中修正公式注释

---

## 5. 附录

### 验证脚本输出

**权重公式验证:**
```
d=0.5 手动计算: [1.0, 0.5, -0.125, 0.0625, -0.0390625]
d=0.5 函数计算: [1.0, 0.5, -0.125, 0.0625, -0.0390625]
差异: 0.0
```

**符号错误验证:**
```
符号对比（修正 vs 当前）:
  w[0]: 修正=+1.0000, 当前=+1.0000 ✓
  w[1]: 修正=-0.5000, 当前=+0.5000 ✗
  w[2]: 修正=-0.1250, 当前=-0.1250 ✓
  w[3]: 修正=-0.0625, 当前=+0.0625 ✗
  w[4]: 修正=-0.0391, 当前=-0.0391 ✓
  w[5]: 修正=-0.0273, 当前=+0.0273 ✗
```

---

*审计人: 寇连材公公*  
*如有疑问，请与长春宫总管李成荣公公联系*
